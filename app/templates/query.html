{% extends "base.html" %}
{% block extendhead %}
    <link href="{{ url_for('static', path='/css/github.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', path='/js/vega/vega@5.22.1.js') }}"></script>
    <script src="{{ url_for('static', path='/js/vega/vega-lite@5.6.0.js') }}"></script>
    <script src="{{ url_for('static', path='/js/vega/vega-embed@6.21.0.js') }}"></script>
{% endblock %}
{% block title %}Query{% endblock %}
{% block header %}
    {% if state is not none %}
    <li>{{ state }}</li>
    {% endif %}
{% endblock %}
{% block content %}
    <h1>Query page</h1>
    <h2>Query</h2>
    <div id="query-editor" class="code-editor language-sql">{{ query }}</div>
    <h2>Vega</h2>
    <div id="vega-editor" class="code-editor language-json">{{ vega }}</div>
    <button
        role="button"
        hx-post="{{ url_for('execute_route', db=db) }}"
        hx-vals="js:{query: query_jar.toString(), vega: vega_jar.toString()}"
        hx-trigger="click"
        hx-target="#query-result"
        hx-swap="innerHTML"
    >
        Trigger
    </button>
    <h2>Result</h2>
    <div id="query-result">
        <p class="htmx-indicator" aria-busy="true">Running query...</p>
    </div>
    <script type="module">
        import {CodeJar} from '{{ url_for("static", path="/js/codejar.min.js") }}'
        import hljs from '{{ url_for("static", path="/js/highlight/core.min.js") }}'
        import json from '{{ url_for("static", path="/js/highlight/json.min.js") }}'
        import sql from '{{ url_for("static", path="/js/highlight/sql.min.js") }}'
        hljs.configure({ignoreUnescapedHTML: true});
        hljs.registerLanguage('json', json);
        hljs.registerLanguage('sql', sql);
        let query_editor = document.getElementById("query-editor");
        let vega_editor = document.getElementById("vega-editor");
        window.query_jar = CodeJar(query_editor, hljs.highlightElement);
        window.vega_jar = CodeJar(vega_editor, hljs.highlightElement);
    </script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
    {% if readme is not none %}
    <div>{{ readme }}</div>
    {% else %}
    <h1>Gitbi Home</h1>
    <p>[Readme file is missing]</p>
    {% endif %}
    <article>
        <header><h3 class="no-margin">Dashboards</h3></header>
        {% for dashboard in dashboards %}
        <a role="button" class="small-button" href="{{ request.app.url_path_for('dashboard_route', state=state, file=dashboard) }}">{{ dashboard|e }}</a>
        {% endfor %}
        <details class="nested-details">
            <summary role="button">New dashboard</summary>
            <fieldset id="dashboard-choices">
                {% for db, queries in databases.items() %}
                    {% for query in queries %}
                    <label for="{{ db|e }}-{{ query|e }}">
                        <input type="checkbox" id="{{ db|e }}/{{ query|e }}" name="{{ db|e }}/{{ query|e }}">
                        <span><strong>{{ db|e }}</strong>: {{ query|e }}</span>
                    </label>
                    {% endfor %}
                {% endfor %}
            </fieldset>
            <div>
                <label for="dashboard-file-name">Dashboard file name</label>
                <input type="text" id="dashboard-file-name" name="dashboard-file-name" placeholder="Enter file name">
                <small>Dashboard name must have <em>.json</em> extension</small>
            </div>
            <div
                role="button"
                class="secondary"
                hx-post="{{ request.app.url_path_for('dashboard_save_route') }}"
                hx-vals="js:{data: dashboard_format()}"
                hx-trigger="click"
                hx-target="#save-error"
                hx-swap="innerHTML"
            >
                Save dashboard
            </div>
            <div id="save-error"></div>
        </details>
    </article>
    <article>
        <header><h3 class="no-margin">Data Sources</h3></header>
        {% if db_toc %}
        <h4>TOC</h4>
        <ol>
            {% for db, _queries in databases.items() %}
            <li><a href="#section-{{ db|e }}">{{ db|e }}</a></li>
            {% endfor %}
        </ol>
        {% endif %}
        {% for db, queries in databases.items() %}
        <a
            class="hidden"
            hx-get="{{ request.app.url_path_for('db_details_route', db=db) }}"
            hx-trigger="load"
            hx-target="#db-details-{{ db }}"
            hx-swap="outerHTML"
        >
            Load table info
        </a>
        <h3 id="section-{{ db|e }}">{{ db|e }}</h3>
        <h4>Queries</h4>
        <a class="small-button" role="button" href="{{ request.app.url_path_for('query_route', db=db) }}">New query</a>
        {% for query in queries %}
        <a role="button" class="small-button" href="{{ request.app.url_path_for('saved_query_route', state=state, db=db, file=query) }}">{{ query|e }}</a>
        {% endfor %}
        <div id="db-details-{{ db }}"></div>
        {% endfor %}
    </article>
    <script type="text/javascript">
        {% include 'js/dashboard_creation.js' %}
    </script>
{% endblock %}

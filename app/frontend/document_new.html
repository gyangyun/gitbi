{% extends "base.html" %}
{% block title %}æ–°å»ºæ–‡æ¡£{% endblock %}

{% block extendhead %}
<!-- å¼•å…¥ç¼–è¾‘å™¨éœ€è¦çš„åº“ -->
<!-- SimpleMDE - Markdownç¼–è¾‘å™¨ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<!-- CKEditor - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
<script src="https://cdn.ckeditor.com/4.16.0/standard/ckeditor.js"></script>

<style>
    .document-container {
        max-width: 1000px;
        margin: 20px auto;
        padding: 30px;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
    }

    .document-header {
        margin-bottom: 20px;
        text-align: center;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .document-title {
        font-size: 24px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }

    .document-description {
        color: #666;
        margin-bottom: 20px;
        text-align: center;
    }

    .method-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
    }

    .method-button {
        padding: 15px 25px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f9f9f9;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 200px;
    }

    .method-button:hover {
        background-color: #f0f0f0;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .method-button.active {
        background-color: #e8f5e9;
        border-color: #4CAF50;
    }

    .method-button-icon {
        font-size: 36px;
        margin-bottom: 10px;
        color: #4CAF50;
    }

    .method-button-title {
        font-weight: 600;
        margin-bottom: 5px;
    }

    .method-button-desc {
        font-size: 12px;
        color: #666;
        text-align: center;
    }

    .method-content {
        display: none;
        margin-top: 20px;
    }

    .method-content.active {
        display: block;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .editor-container {
        min-height: 400px;
        margin-bottom: 20px;
    }

    .actions {
        margin-top: 20px;
        text-align: right;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }

    .btn-secondary {
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
    }

    .message {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
    }

    .success-message {
        background-color: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
    }

    .error-message {
        background-color: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
    }

    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 40px 20px;
        text-align: center;
        margin-bottom: 20px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .file-upload-area:hover,
    .file-upload-area.dragover {
        background-color: #f9f9f9;
        border-color: #4CAF50;
    }

    .file-upload-icon {
        font-size: 48px;
        color: #4CAF50;
        margin-bottom: 15px;
    }

    .file-upload-text {
        margin-bottom: 15px;
    }

    .upload-progress {
        display: none;
        margin-top: 20px;
    }

    .progress-bar {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        margin-bottom: 5px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background-color: #4CAF50;
        width: 0%;
        transition: width 0.3s;
    }

    .progress-text {
        font-size: 12px;
        color: #666;
    }

    .uploaded-file-info {
        display: none;
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }

    .file-name {
        font-weight: 600;
    }

    .file-type {
        color: #666;
        font-size: 12px;
    }

    .file-controls {
        margin-top: 10px;
    }

    .type-selector {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }

    .type-option {
        padding: 8px 16px;
        margin-right: 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .type-option:hover {
        background-color: #f0f0f0;
    }

    .type-option.active {
        background-color: #e8f5e9;
        color: #4CAF50;
        font-weight: 600;
    }
</style>

<script>
    let markdownEditor = null;
    let richTextEditor = null;
    let selectedType = 'txt'; // é»˜è®¤æ–‡æ¡£ç±»å‹
    let uploadedFile = null;

    // åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ–æ–¹æ³•é€‰æ‹©æŒ‰é’®
        setupMethodButtons();

        // åˆå§‹åŒ–æ‹–æ”¾ä¸Šä¼ 
        setupDragAndDrop();

        // åˆå§‹åŒ–ç¼–è¾‘å™¨ (é»˜è®¤)
        initEditor();

        // æ–‡æ¡£ç±»å‹é€‰æ‹©å™¨
        setupTypeOptions();
    });

    function setupMethodButtons() {
        const buttons = document.querySelectorAll('.method-button');
        const contents = document.querySelectorAll('.method-content');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                buttons.forEach(b => b.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                // æ·»åŠ æ–°çš„æ´»åŠ¨çŠ¶æ€
                button.classList.add('active');
                const target = button.getAttribute('data-target');
                document.getElementById(target).classList.add('active');
            });
        });

        // é»˜è®¤é€‰ä¸­ä¸Šä¼ æ–¹å¼
        document.querySelector('.method-button[data-target="upload-method"]').click();
    }

    function setupDragAndDrop() {
        const uploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('file-input');

        // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // æ–‡ä»¶æ‹–æ”¾äº‹ä»¶
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        fileInput.addEventListener('change', handleFileSelect);
    }

    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        const uploadedFileInfo = document.getElementById('uploaded-file-info');
        const fileNameElement = document.getElementById('file-name');
        const fileTypeElement = document.getElementById('file-type');
        const uploadProgress = document.getElementById('upload-progress');

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            uploadedFile = file;

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileNameElement.textContent = file.name;

            // ç¡®å®šæ–‡ä»¶ç±»å‹
            let fileType = "æœªçŸ¥ç±»å‹";
            if (file.name.toLowerCase().endsWith('.docx')) {
                fileType = "Microsoft Word æ–‡æ¡£ (.docx)";
            } else if (file.name.toLowerCase().endsWith('.md')) {
                fileType = "Markdown æ–‡æ¡£ (.md)";
            } else if (file.name.toLowerCase().endsWith('.txt')) {
                fileType = "æ–‡æœ¬æ–‡æ¡£ (.txt)";
            }

            fileTypeElement.textContent = fileType;

            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯åŒºåŸŸ
            uploadedFileInfo.style.display = 'block';

            // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦ (ä»…è§†è§‰æ•ˆæœ)
            uploadProgress.style.display = 'block';
            const progressFill = document.querySelector('.progress-bar-fill');
            const progressText = document.querySelector('.progress-text');

            progressFill.style.width = '0%';
            let progress = 0;

            const interval = setInterval(() => {
                progress += 10;
                progressFill.style.width = progress + '%';
                progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ... ' + progress + '%';

                if (progress >= 100) {
                    clearInterval(interval);
                    progressText.textContent = 'æ–‡ä»¶å·²å°±ç»ª';
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                    }, 1000);
                }
            }, 50);

            // è®¾ç½®æ–‡æ¡£åç§°è¾“å…¥æ¡†çš„é»˜è®¤å€¼ä¸ºæ–‡ä»¶å(ä¸å«æ‰©å±•å)
            const fileName = file.name.split('.').slice(0, -1).join('.');
            document.getElementById('upload-document-name').value = fileName;
        }
    }

    function setupTypeOptions() {
        const typeOptions = document.querySelectorAll('.type-option');

        typeOptions.forEach(option => {
            option.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                typeOptions.forEach(o => o.classList.remove('active'));

                // æ·»åŠ æ–°çš„æ´»åŠ¨çŠ¶æ€
                option.classList.add('active');
                selectedType = option.getAttribute('data-type');

                // åˆ‡æ¢ç¼–è¾‘å™¨ç±»å‹
                switchEditor(selectedType);
            });
        });
    }

    function initEditor() {
        const textArea = document.getElementById('editor-content');

        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ (é»˜è®¤)
        CKEDITOR.replace('editor-content', {
            height: 400
        });
        richTextEditor = CKEDITOR.instances['editor-content'];
    }

    function switchEditor(type) {
        const content = getEditorContent();

        // æ¸…é™¤ç°æœ‰ç¼–è¾‘å™¨
        if (richTextEditor) {
            richTextEditor.destroy();
            richTextEditor = null;
        }

        if (markdownEditor) {
            markdownEditor.toTextArea();
            markdownEditor = null;
        }

        // åˆ›å»ºæ–°ç¼–è¾‘å™¨
        if (type === 'md') {
            markdownEditor = new SimpleMDE({
                element: document.getElementById('editor-content'),
                spellChecker: false
            });
            markdownEditor.value(content);
        } else {
            CKEDITOR.replace('editor-content', {
                height: 400
            });
            richTextEditor = CKEDITOR.instances['editor-content'];
            richTextEditor.setData(content);
        }
    }

    function getEditorContent() {
        if (markdownEditor) {
            return markdownEditor.value();
        } else if (richTextEditor) {
            return richTextEditor.getData();
        }
        return document.getElementById('editor-content').value;
    }

    async function uploadDocument(event) {
        event.preventDefault();

        if (!uploadedFile) {
            showMessage('<div class="error-message">è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶</div>');
            return;
        }

        const documentName = document.getElementById('upload-document-name').value.trim();

        try {
            const formData = new FormData();

            // å¦‚æœæŒ‡å®šäº†æ–‡æ¡£åï¼Œä½¿ç”¨æŒ‡å®šçš„åç§°ï¼Œå¦åˆ™ä½¿ç”¨åŸå§‹æ–‡ä»¶å
            let fileName = documentName || uploadedFile.name;
            formData.append('file_name', fileName);
            formData.append('file', uploadedFile);

            const response = await fetch('{{ request.app.url_path_for("document_save_route") }}', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const message = await response.text();
                showMessage(message);

                // ä¸Šä¼ æˆåŠŸåè·³è½¬
                setTimeout(() => {
                    window.location.href = '{{ request.app.url_path_for("home_default_route") }}';
                }, 1500);
            } else {
                const errorText = await response.text();
                let errorMessage;
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.detail || 'ä¸Šä¼ å¤±è´¥';
                } catch (e) {
                    errorMessage = errorText || 'ä¸Šä¼ å¤±è´¥';
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('ä¸Šä¼ æ–‡ä»¶æ—¶å‡ºé”™:', error);
            showMessage('<div class="error-message">ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + error.message + '</div>');
        }
    }

    async function saveDocument(event) {
        event.preventDefault();

        const documentName = document.getElementById('editor-document-name').value.trim();
        if (!documentName) {
            showMessage('<div class="error-message">è¯·è¾“å…¥æ–‡æ¡£åç§°</div>');
            return;
        }

        // è·å–å†…å®¹
        const content = getEditorContent();

        // æ„å»ºæ–‡ä»¶å
        let fileName = documentName;
        if (!fileName.toLowerCase().endsWith('.' + selectedType)) {
            fileName += '.' + selectedType;
        }

        // å‘é€åˆ°æœåŠ¡å™¨
        try {
            const formData = new FormData();
            formData.append('file_name', fileName);
            formData.append('content', content);
            formData.append('selected_type', selectedType);

            const response = await fetch('{{ request.app.url_path_for("document_save_route") }}', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const message = await response.text();
                showMessage(message);

                // ä¿å­˜æˆåŠŸåè·³è½¬
                setTimeout(() => {
                    window.location.href = '{{ request.app.url_path_for("home_default_route") }}';
                }, 1500);
            } else {
                const errorText = await response.text();
                let errorMessage;
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.detail || 'ä¿å­˜å¤±è´¥';
                } catch (e) {
                    errorMessage = errorText || 'ä¿å­˜å¤±è´¥';
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('ä¿å­˜æ–‡æ¡£æ—¶å‡ºé”™:', error);
            showMessage('<div class="error-message">ä¿å­˜æ–‡æ¡£å¤±è´¥: ' + error.message + '</div>');
        }
    }

    function showMessage(message) {
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            messageDiv.innerHTML = message;
            messageDiv.scrollIntoView({ behavior: 'smooth' });
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        } else {
            console.error('æ‰¾ä¸åˆ°æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ');
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="document-container">
    <div class="document-header">
        <h1 class="document-title">æ–°å»ºæ–‡æ¡£</h1>
    </div>

    <div class="document-description">
        è¯·é€‰æ‹©åˆ›å»ºæ–‡æ¡£çš„æ–¹å¼ï¼Œä½ å¯ä»¥ä¸Šä¼ ç°æœ‰æ–‡æ¡£æˆ–ä½¿ç”¨ç¼–è¾‘å™¨æ–°å»ºæ–‡æ¡£
    </div>

    <div id="message" class="message"></div>

    <!-- æ–¹æ³•é€‰æ‹©æŒ‰é’® -->
    <div class="method-buttons">
        <div class="method-button" data-target="upload-method">
            <div class="method-button-icon">ğŸ“¤</div>
            <div class="method-button-title">ä¸Šä¼ æ–‡æ¡£</div>
            <div class="method-button-desc">ä¸Šä¼ ç°æœ‰çš„æ–‡æ¡£æ–‡ä»¶</div>
        </div>
        <div class="method-button" data-target="editor-method">
            <div class="method-button-icon">ğŸ“</div>
            <div class="method-button-title">ç¼–è¾‘å™¨åˆ›å»º</div>
            <div class="method-button-desc">ä½¿ç”¨ç¼–è¾‘å™¨åˆ›å»ºæ–°æ–‡æ¡£</div>
        </div>
    </div>

    <!-- ä¸Šä¼ æ–‡æ¡£æ–¹å¼ -->
    <div id="upload-method" class="method-content">
        <form id="upload-form" enctype="multipart/form-data">
            <div id="file-upload-area" class="file-upload-area">
                <div class="file-upload-icon">ğŸ“„</div>
                <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
                <div>æ”¯æŒ .txt, .md, .docx æ–‡ä»¶æ ¼å¼</div>
                <input type="file" id="file-input" style="display: none;" accept=".txt,.md,.docx">
            </div>

            <div id="upload-progress" class="upload-progress">
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="progress-text">å‡†å¤‡ä¸Šä¼ ...</div>
            </div>

            <div id="uploaded-file-info" class="uploaded-file-info">
                <div class="file-name" id="file-name"></div>
                <div class="file-type" id="file-type"></div>
            </div>

            <div class="form-group">
                <label for="upload-document-name">æ–‡æ¡£åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨æ–‡ä»¶åï¼‰</label>
                <input type="text" id="upload-document-name" class="form-control" placeholder="è¾“å…¥æ–‡æ¡£åç§°ï¼Œä¸å«æ‰©å±•å">
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="uploadDocument(event)">ä¸Šä¼ æ–‡æ¡£</button>
            </div>
        </form>
    </div>

    <!-- ç¼–è¾‘å™¨åˆ›å»ºæ–¹å¼ -->
    <div id="editor-method" class="method-content">
        <form id="editor-form">
            <div class="form-group">
                <label for="editor-document-name">æ–‡æ¡£åç§°</label>
                <input type="text" id="editor-document-name" class="form-control" placeholder="è¾“å…¥æ–‡æ¡£åç§°ï¼Œä¸å«æ‰©å±•å" required>
            </div>

            <div class="type-selector">
                <div class="type-option active" data-type="txt">æ–‡æœ¬æ–‡æ¡£</div>
                <div class="type-option" data-type="md">Markdown</div>
            </div>

            <div class="form-group">
                <label for="editor-content">æ–‡æ¡£å†…å®¹</label>
                <div class="editor-container">
                    <textarea id="editor-content" class="form-control"></textarea>
                </div>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-secondary" onclick="window.history.back()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveDocument(event)">ä¿å­˜æ–‡æ¡£</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}